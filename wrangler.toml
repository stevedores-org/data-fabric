name = "data-fabric-worker"
main = "build/worker/shim.mjs"
compatibility_date = "2026-02-22"
account_id = "f1be33af27cf878e2e81cb29a0d886f7"
workers_dev = true

# ── Custom domain ────────────────────────────────────────────────
[[routes]]
pattern = "data-fabric.stevedores.org/*"
zone_name = "stevedores.org"

[build]
command = "cargo install worker-build && worker-build --release"

# deploy: bun run deploy
# dev:    bun run dev

[vars]
APP_ENV = "dev"
SERVICE_NAME = "data-fabric"

# ── D1: structured metadata, lineage, domain entities ───────────
# Create DB: wrangler d1 create data-fabric
# Apply migrations: wrangler d1 migrations apply data-fabric --remote
[[d1_databases]]
binding = "DB"
database_name = "data-fabric"
database_id = "placeholder-provision-with-wrangler-d1-create"
migrations_dir = "migrations"

# ── R2: artifact / blob store ────────────────────────────────────
# Create bucket: wrangler r2 bucket create data-fabric-artifacts
[[r2_buckets]]
binding = "ARTIFACTS"
bucket_name = "data-fabric-artifacts"

# ── KV: policies, config, fast context lookups ───────────────────
[[kv_namespaces]]
binding = "POLICY_KV"
id = "placeholder-provision-with-wrangler-kv-namespace-create"
preview_id = "placeholder-provision-with-wrangler-kv-namespace-create"

# ── Queues: provenance event bus, enrichment consumer ─────────────
# Create queue: wrangler queues create data-fabric-events
# [[queues.producers]]
# binding = "EVENTS"
# queue = "data-fabric-events"
#
[[queues.consumers]]
queue = "data-fabric-events"
max_batch_size = 50
max_batch_timeout = 5
